import{E as b,e as p,f as P,c as d,o as u,g as m,a as n,w as U,v as x,F as f,h as I,n as L,u as R,t as v}from"./app-ByNEC-t7.js";import{_ as S}from"./plugin-vue_export-helper-DlAUqK2U.js";function T(i=window.location.href){try{const o=new URL(i),s=`${o.protocol}//${o.host}`.length+1;let r=i.substring(s);const l=decodeURIComponent(r).replace(/\//g,"_");return l.length>5?l.substring(0,l.length-5):""}catch(o){return console.error("解析URL或处理路径时出错:",o),""}}function A(i){return!i||i.code!==200||!Array.isArray(i.data)?[]:i.data.map(o=>{var c,s;return{id:o.commentId,postId:o.articlePath,author:((c=o.user)==null?void 0:c.username)||"匿名用户",avatar:((s=o.user)==null?void 0:s.avatarUrl)||"https://via.placeholder.com/36",content:o.content,likes:o.likeCount??0,time:o.createdAt?o.createdAt.replace("T"," "):""}})}const $={class:"editor"},j=["disabled"],D={class:"editor-actions"},B={key:0,class:"comment-list"},G=["src"],M={class:"content"},V={class:"meta"},z={class:"author"},E={class:"time"},F={class:"text"},H={class:"actions"},N=["onClick"],O={__name:"Comment",setup(i){const{isDarkMode:o}=b(),c=p([]),s=p(""),r=p(null),h=p("");async function l(){if(h.value)try{const e=`http://localhost:8081/api/comments/article/${h.value}`,a=await(await fetch(e)).json();c.value=A(a)}catch(e){console.error("加载评论失败",e)}}async function _(){if(!s.value.trim()){alert("评论内容不能为空！");return}if(!r.value){alert("请先登录后再发表评论！");return}try{const e=r.value.githubid,a=await(await fetch("http://localhost:8081/api/comments",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({userId:e,articlePath:h.value,content:s.value}),credentials:"include"})).json();a.code===200?(s.value="",l()):alert(a.message||"提交评论失败")}catch(e){console.error("提交评论失败",e),alert("网络错误，提交失败")}}async function g(e){if(!r.value){alert("请先登录后再点赞！");return}try{const t=r.value.githubid,w=await(await fetch("http://localhost:8081/api/comment-likes",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({userId:t,commentId:e}),credentials:"include"})).json();w.error?alert(w.message||"点赞失败"):l()}catch(t){console.error("点赞失败",t),alert("网络错误，点赞失败")}}function y(){if(typeof window>"u")return;const t=`http://localhost:8081/oauth2/authorization/github?redirect_uri=${encodeURIComponent(window.location.href)}`;window.open(t,"_self")}function k(){if(typeof window>"u")return;const e=new URLSearchParams(window.location.search),t=e.get("error");t&&console.log("授权失败：",t,e.get("message"))}async function C(){try{const t=await(await fetch("http://localhost:8081/api/auth/me",{credentials:"include"})).json();r.value=t.error?null:t}catch(e){console.error("获取用户失败",e),r.value=null}}return P(()=>{typeof window<"u"&&(h.value=T(window.location.href),k(),l(),C())}),(e,t)=>(u(),d(f,null,[m(" 评论整体容器 "),n("div",{class:L(["comment-section",{dark:R(o)}])},[t[2]||(t[2]=n("h3",null,"评论",-1)),m(" 输入框区域 "),n("div",$,[U(n("textarea",{"onUpdate:modelValue":t[0]||(t[0]=a=>s.value=a),class:"editor-input",placeholder:"登录后可发表评论...",disabled:!r.value},null,8,j),[[x,s.value]]),n("div",D,[m(" 未登录时显示 GitHub 登录按钮 "),r.value?(u(),d(f,{key:1},[m(" 登录后显示提交按钮 "),n("button",{class:"submit-btn",onClick:_}," 提交 ")],2112)):(u(),d("button",{key:0,class:"login-btn",onClick:y}," 使用 GitHub 登录 "))])]),m(" 评论列表 "),c.value.length>0?(u(),d("div",B,[(u(!0),d(f,null,I(c.value,a=>(u(),d("div",{key:a.id,class:"comment-item"},[n("img",{src:a.avatar,alt:"avatar",class:"avatar"},null,8,G),n("div",M,[n("div",V,[n("span",z,v(a.author),1),n("span",E,v(a.time),1)]),n("p",F,v(a.content),1),n("div",H,[n("span",{class:"like",onClick:w=>g(a.id)},"👍 "+v(a.likes),9,N)])])]))),128))])):(u(),d(f,{key:1},[m(" 无评论时提示 "),t[1]||(t[1]=n("div",{class:"no-comment"},"暂无评论",-1))],2112))],2)],2112))}},K=S(O,[["__scopeId","data-v-9fea7d25"]]);export{K as C};
